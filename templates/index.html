{% load static %}
<html lang="en">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=-1, shrink-to-fit=yes">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Traffic Analysis- Dashboard</title>

    <!-- Custom fonts for this template-->
    <link href="{% static 'vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet" type="text/css">

    <!-- Page level plugin CSS-->
    <link href="{% static 'vendor/datatables/dataTables.bootstrap4.css' %}" rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="{% static 'css/sb-admin.css' %}" rel="stylesheet">
    <link href="{% static 'css/other.css' %}" rel="stylesheet">
    <link href="{% static 'css/promise.css' %}" rel="stylesheet">
    <script src="{% static 'js/promise.js' %}"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>

<script>
var val1 = "{{data.0.0}}";
var val2 = "{{data.1.0}}";
var val3 = "{{data.2.0}}";
var val4 = "{{data.3.0}}";
console.log(val1);
console.log(val2);
console.log(val3);
console.log(val4);
</script>

<script>
function timer0(count) {
    //document.getElementById("start").disabled = true;
    //document.write(count);
    return new Promise(resolve => {
        document.getElementById("blue-3").style.backgroundColor = "green";
        document.getElementById("blue-1").style.backgroundColor = "black";
        let counter = setInterval(() => {
            count = count - 1;
            if (count < 0) {
                clearInterval(counter);
                document.getElementById("countdown1").innerHTML = "Timer disabled";
                resolve();
            } else
                document.getElementById("countdown1").innerHTML = count + " seconds remaining";
            if (count == 3) {
                document.getElementById("yellow-1").style.backgroundColor = "black";
                document.getElementById("yellow-2").style.backgroundColor = "yellow";
            }
            if (count == -1) {
                document.getElementById("blue-3").style.backgroundColor = "black";
                document.getElementById("blue-1").style.backgroundColor = "red";
                document.getElementById("yellow-2").style.backgroundColor = "black";
            }
        }, 1000);
    });
}

function timer1(count) {
    //document.write(count);
    return new Promise(resolve => {
        document.getElementById("yellow-3").style.backgroundColor = "green";
        document.getElementById("yellow-1").style.backgroundColor = "black";
        let counter = setInterval(() => {
            count = count - 1;
            if (count < 0) {
                clearInterval(counter);
                document.getElementById("countdown2").innerHTML = "Timer disabled";
                resolve();
            } else
                document.getElementById("countdown2").innerHTML = count + " seconds remaining";
            if (count == 3) {
                document.getElementById("red-1").style.backgroundColor = "black";
                document.getElementById("red-2").style.backgroundColor = "yellow";
            }
            if (count == -1) {
                document.getElementById("yellow-3").style.backgroundColor = "black";
                document.getElementById("yellow-1").style.backgroundColor = "red";
                document.getElementById("red-2").style.backgroundColor = "black";
            }
        }, 1000);
    });
}

function timer2(count) {
    //document.write(count);
    return new Promise(resolve => {
        document.getElementById("red-3").style.backgroundColor = "green";
        document.getElementById("red-1").style.backgroundColor = "black";
        let counter = setInterval(() => {
            count = count - 1;
            if (count < 0) {
                clearInterval(counter);
                document.getElementById("countdown3").innerHTML = "Timer disabled";
                resolve();
            } else
                document.getElementById("countdown3").innerHTML = count + " seconds remaining";
            if (count == 3) {
                document.getElementById("green-1").style.backgroundColor = "black";
                document.getElementById("green-2").style.backgroundColor = "yellow";
            }
            if (count == -1) {
                document.getElementById("red-3").style.backgroundColor = "black";
                document.getElementById("red-1").style.backgroundColor = "red";
                document.getElementById("green-2").style.backgroundColor = "black";
            }
        }, 1000);
    });
}

function timer3(count) {
    //document.write(count);
    return new Promise(resolve => {
        document.getElementById("green-3").style.backgroundColor = "green";
        document.getElementById("green-1").style.backgroundColor = "black";
        let counter = setInterval(() => {
            count = count - 1;
            if (count < 0) {
                clearInterval(counter);
                document.getElementById("countdown4").innerHTML = "Timer disabled";
                resolve();
            } else
                document.getElementById("countdown4").innerHTML = count + " seconds remaining";
            if (count == -1) {
                document.getElementById("green-3").style.backgroundColor = "black";
                document.getElementById("green-1").style.backgroundColor = "red";
                document.getElementById("start").disabled = false;
            }
        }, 1000);
    });
}
</script>
</head>

<body id="page-top">
    <nav class="navbar navbar-expand navbar-dark bg-dark static-top">

        <a class="navbar-brand mr-1" href="index.html">Traffic Analysis</a>
        <input type="hidden" id="totaltime" style="visibility:hidden;display:none;color:white;">{{totaltime}}</input>
        <button class="btn btn-link btn-sm text-white order-1 order-sm-0" id="sidebarToggle" href="#">
            <i class="fas fa-bars"></i>
        </button>


        <!-- Navbar Search -->
        <form class="d-none d-md-inline-block form-inline ml-auto mr-0 mr-md-3 my-2 my-md-0">
        </form>

        <!-- Navbar -->
        <ul class="navbar-nav ml-auto ml-md-0">
           <a href="{% url 'stats' %}">
            <button type="button" class="btn btn-outline-warning">Statistics</button>
        </a>
            <!-- The Modal -->
            <div id="myModal" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <p><img src="{% static 'img/road.jpg' %}" style="float: left;" />&nbsp;&nbsp;<b><font color="blue">Road 1</font></b><br /><br />&nbsp;&nbsp;<b><font color="Orange">Road 2</font></b><br /><br />&nbsp;&nbsp;<b><font color="green">Road 3</font></b><br /><br />&nbsp;&nbsp;<b><font color="red">Road 4</font></b></p>
                </div>
            </div>

            <script>
                var modal = document.getElementById("myModal");
                var btn = document.getElementById("myBtn");
                var span = document.getElementsByClassName("close")[0];
                btn.onclick = function () {
                    modal.style.display = "block";
                }
                span.onclick = function () {
                    modal.style.display = "none";
                }
                window.onclick = function (event) {
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                }
            </script>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="alertsDropdown">
                    <a class="dropdown-item" href="#">Action</a>
                    <a class="dropdown-item" href="#">Another action</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">Something else here</a>
                </div>
            </li>
            <!--
    <li class="nav-item dropdown no-arrow mx-1">
        <a class="nav-link dropdown-toggle" href="#" id="messagesDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-envelope fa-fw"></i>
            <span class="badge badge-danger">7</span>
        </a>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="messagesDropdown">
            <a class="dropdown-item" href="#">Action</a>
            <a class="dropdown-item" href="#">Another action</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#">Something else here</a>
        </div>
    </li>-->

            <li class="nav-item dropdown no-arrow">
                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user-circle fa-fw"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                    <p style="padding:5px 5px 5px 30px;">{{request.user}}</p>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{% url 'logout' %}">Logout</a>
                </div>
            </li>
        </ul>

    </nav>

    <div id="wrapper">

        <!-- Sidebar -->

        <!-- Sliding div starts here
    <div class="contact">
        <div class="toggle"></div>
        <h2>Contact Us</h2>
        <div class="scroll">
            <form>
                <input type="text" name="" placeholder="Name">
                <input type="email" name="" placeholder="Email">
                <input type="rel" name="" placeholder="Phone Number">
                <textarea placeholder="Message here.."></textarea>
                <input type="submit" name="" value="send">
            </form>
        </div>-->

        <div id="content-wrapper">
            <div class="container-fluid">

                <!-- Breadcrumbs-->
                <div class="breadcrumb" style="width:100%;">
                    <div style="float: right;font-size:20px;  font-family:'Times New Roman'; ">
                        {% csrf_token %}
                        <form action="place" method="get">
                            <br>Place:<input type="text" name="place">
                            <br><br><input class="btn btn-outline-success btn-lg" type="submit">
                        </form>
                        <p>{{lat}}  {{lon}}</p>
                    </div>
                    <script>
                            document.getElementById("start").disabled = true;
                    </script>
                    <div class="info" style="font-size:27px; font-family:'Times New Roman'; ">
                        Dashboard
                        <div style="font-size:20px;">
                            <button class="breadcrumb-button" id="fetch" onclick="document.getElementById('start').disabled = false; location.href = '{% url 'fetch' %}'; " style="vertical-align:middle"><span>Fetch</span></button>
                            {{message}}<br />

                        </div>
                    </div>

                    <script>
                    function staart() {
                       timer0(val1)
                      .then(()=>timer1(val2))
                      .then(() => timer2(val3))
                      .then(() => timer3(val4));
                    }
                    </script>

                    <button class="btn btn-outline-success btn-lg" id="start" onclick="staart()" style="display:none;">Start
                    </button>
                    <button class="btn btn-outline-success btn-lg" id="test">Start
                    </button>
                    <button class="btn btn-outline-danger btn-lg" id="stop">Stop
                    </button>

                    <script type="text/javascript">
                    var ajax_req;
    $('#test').click(function(){
       $("#start").trigger('click');
      var timeset = 130;
      //timeset var is total time to wait for next cycle. So total 4 roads each road max 30secs so 120 + 10 (buffer time)
      //ajax request continous ke liye setInterval function use kiya hai, nhi time change nhi hora he
      //130 seconds rukna padega total
      var flag = 1;
      timeset = timeset * 1000;
      //as isme time millisecs mai rehta hai toh *1000 kiya hai
      timer = setInterval(function(){
    ajax_req = $.ajax(
    {
        type:"POST",
        url: "http://127.0.0.1:5000/display", //flask ka url niche wala json ka data ja rha hai
        data: JSON.stringify({a: ["{{db.0.0}}","{{db.0.1}}","{{db.0.2}}","{{db.0.3}}"] , b: ["{{db.1.0}}","{{db.1.1}}","{{db.1.2}}","{{db.1.3}}"] , c: ["{{db.2.0}}","{{db.2.1}}","{{db.2.2}}","{{db.2.3}}"] , d: ["{{db.3.0}}","{{db.3.1}}","{{db.3.2}}","{{db.3.3}}"] , flag: flag}),
        contentType: "application/json; charset=utf-8",
        success: function( data )
        {
          //api Successfully hit hone ke baad ye chalega
            val1 = data.t1;
            val2 = data.t2;
            val3 = data.t3;
            val4 = data.t4;
            //val1-4 is new time returned by flask api
            rval1 = data.r1;
            rval2 = data.r2;
            rval3 = data.r3;
            rval4 = data.r4;
            //road name
            $( '#time1' ).text("Time: " + data.t1 + " seconds");
            $( '#time2' ).text("Time: " + data.t2 + " seconds");
            $( '#time3' ).text("Time: " + data.t3 + " seconds");
            $( '#time4' ).text("Time: " + data.t4 + " seconds");
            $( '#rname1' ).text(rval1);
            $( '#rname2' ).text(rval2);
            $( '#rname3' ).text(rval3);
            $( '#rname4' ).text(rval4);
            //change html elements
            console.log(rval1);
            console.log(rval2);
            console.log(rval3);
            console.log(rval4);
            flag++;
            console.log(flag);
            //woh flask ke liye laga tha isliye, 1st time ke liye chahiye tha
            staart();
            //staart() is to start the cycle
        }
     })},timeset)
});
$('#stop').click(function(){
  clearTimeout(timer);
  //stop function, stop button dabane se band hojayega but only after next cycle, current cycle will execute
  console.log('Stopped');
});
</script>
                </div>
                <!-- Icon Cards-->
                <div class="row">
                    <div class="col-xl-5col-sm-7mb-3" style="height:290px; width:500px; float: left">
                        <div class="card text-white bg-danger o-hidden h-100">
                            <div class="card-body">
                                <!--<p>Road 1</p>-->
                                <p>Road with highest traffic</p>
                                <p id="rname1">{{data.0.1}}</p>
                                <p id = "time1">Time: {{data.0.0}} seconds</p>
                                <p>
                                    Traffic light:
                                    <div id="blue-1" class="ON"></div>&nbsp;&nbsp;
                                    <div id="blue-2" style="background-color:black"></div>&nbsp;&nbsp;
                                    <div id="blue-3" style="background-color:black"></div>&nbsp;&nbsp;
                                    <br />
                                <p id="countdown1">Timer disabled</p>
                                </p>
                            </div>

                        </div>
                    </div>

                    <div class="col-xl-5 col-sm-7 mb-3" style="height:290px; width:500px; float: right">
                        <div class="card text-white bg-warning o-hidden h-100">
                            <div class="card-body">
                                <p>Road with medium traffic</p>
                                <p id="rname2">{{data.1.1}}</p>
                                <p id = "time2">Time: {{data.1.0}} seconds</p>
                                <!--<p>{{name2}}</p>-->
                                <p>
                                    Traffic light:
                                    <div id="yellow-1" class="ON"></div>&nbsp;&nbsp;
                                    <div id="yellow-2" style="background-color:black"></div>&nbsp;&nbsp;
                                    <div id="yellow-3" style="background-color:black"></div>&nbsp;&nbsp;
                                    <br />
                                <p id="countdown2">Timer disabled</p>
                                </p>
                            </div>

                            <!--<a class="card-footer text-white clearfix small z-1" href="#">
                            <span class="float-left">View Details</span>
                            <span class="float-right">
                                <i class="fas fa-angle-right"></i>
                            </span>
                        </a>-->
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xl-5 col-sm-7 mb-3" style="height:350px; width:500px; float:left; padding-top:5vw">
                        <div class="card text-white bg-primary o-hidden h-100">
                            <div class="card-body">
                                <p>Road with lesser traffic</p>
                                <p id="rname4">{{data.3.1}}</p>
                                <p id = "time4">Time: {{data.3.0}} seconds</p>
                                <!--<p>{{name3}}</p>-->
                                <p>
                                    Traffic light:
                                    <div id="green-1" class="ON"></div>&nbsp;&nbsp;


                                    <div id="green-2" style="background-color:black"></div>&nbsp;&nbsp;
                                    <div id="green-3" style="background-color:black"></div>&nbsp;&nbsp;

                                    <br />
                                <p id="countdown4">Timer disabled</p>
                                </p>
                            </div>
                            <!--<a class="card-footer text-white clearfix small z-1" href="#">
                            <span class="float-left">View Details</span>
                            <span class="float-right">
                                <i class="fas fa-angle-right"></i>
                            </span>
                        </a>-->
                        </div>
                    </div>
                    <div class="col-xl-5 col-sm-7 mb-3" style="height:330px; width:500px; float: right; padding-top:4vw">
                        <div class="card text-white bg-success o-hidden h-100">
                            <div class="card-body">
                                <p>Road with less traffic</p>
                                <p id="rname3">{{data.2.1}}</p>
                                <p id = "time3">Time: {{data.2.0}} seconds</p>
                                <!--<p>{{name4}}</p>-->
                                <p>
                                    Traffic light:
                                    <div id="red-1" class="ON"></div>&nbsp;&nbsp;
                                    <div id="red-2" style="background-color:black"></div>&nbsp;&nbsp;
                                    <div id="red-3" style="background-color:black"></div>&nbsp;&nbsp;
                                    <br />
                                <p id="countdown3">Timer disabled</p>
                                <script>

                                </script>
                                </p>
                            </div>

                            <!--<a class="card-footer text-white clearfix small z-1" href="#">
                            <span class="float-left">View Details</span>
                            <span class="float-right">
                                <i class="fas fa-angle-right"></i>
                            </span>
                        </a>-->
                        </div>
                    </div>
                </div>
                <!--slider-->
            </div>

        </div>
        <!-- /#wrapper -->
        <!-- Scroll to Top Button-->
        <a class="scroll-to-top rounded" href="#page-top">
            <i class="fas fa-angle-up"></i>
        </a>

        <!-- Logout Modal-->
        <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                        <a class="btn btn-primary" href="login.html">Logout</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap core JavaScript-->
        <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
        <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

        <!-- Core plugin JavaScript-->
        <script src="{% static 'vendor/jquery-easing/jquery.easing.min.js' %}"></script>

        <!-- Page level plugin JavaScript-->
        <script src="{% static 'vendor/chart.js/Chart.min.js' %}"></script>
        <script src="{% static 'vendor/datatables/jquery.dataTables.js' %}"></script>
        <script src="{% static 'vendor/datatables/dataTables.bootstrap4.js' %}"></script>

        <!-- Custom scripts for all pages-->
        <script src="{% static 'js/sb-admin.min.js' %}"></script>

        <!-- Demo scripts for this page-->
        <script src="{% static 'js/demo/datatables-demo.js' %}"></script>
        <script src="{% static 'js/demo/chart-area-demo.js' %}"></script>
</body>

</html>
